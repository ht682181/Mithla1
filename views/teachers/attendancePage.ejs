<%- layout("/layouts/boilerplateTeacher") -%>

<div class="container mt-3">
  <!-- Page Header -->
  <div class="text-center mb-4">
    <h3 class="fw-bold text-primary">üìù Mark Attendance</h3>
    <p class="text-muted">Date: <%= new Date().toDateString() %></p>
  </div>

  <!-- Inputs Row -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label for="period" class="form-label fw-bold">Period</label>
      <input id="period" type="number" min="1" max="6" class="form-control shadow-sm" placeholder="Enter period number" required list="option">
      <datalist id="option">
        <% for(let i=1;i<=6;i++){ %>
          <option value="<%= i %>"></option>
        <% } %>
      </datalist>
    </div>

    <div class="col-md-4">
      <label for="unit" class="form-label fw-bold">Unit</label>
      <input id="unit" type="text" class="form-control shadow-sm" placeholder="Enter unit number" required>
    </div>

    <div class="col-md-4">
      <label for="subject" class="form-label fw-bold">Subject</label>
      <select id="subject" class="form-control shadow-sm" required>
        <option value="">Choose subject</option>
        <% for(let sub of commonSubjects){ %>
          <option value="<%= sub %>"><%= sub %></option>
        <% } %>
      </select>
    </div>
  </div>

  <!-- Description -->
  <!-- <div class="mb-3">
    <label for="description" class="form-label fw-bold">Description</label>
    <textarea id="description" rows="3" class="form-control shadow-sm" placeholder="Enter description... max 80 character only"  required></textarea>
  </div> -->

  <div class="mb-3">
  <label for="description" class="form-label fw-bold">
    Description <small class="text-muted">(max 200 characters)</small>
  </label>

  <textarea
    id="description"
    name="description"
    rows="3"
    class="form-control shadow-sm"
    placeholder="Enter description... max 200 characters only"
    maxlength="200"
    required
  ></textarea>

  <div class="d-flex justify-content-between mt-1">
    <small class="text-muted">Max 200 characters</small>
    <small id="charCount" class="fw-semibold text-secondary">0 / 200</small>
  </div>
</div>


  <!-- Search & Bulk Actions -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-6 d-flex mb-2 mb-md-0">
      <input type="text" id="searchInput" class="form-control me-2 shadow-sm" placeholder="Search by name...">
      <button type="button" id="searchBtn" class="btn btn-primary shadow-sm">Search</button>
      <button type="button" id="backBtn" class="btn btn-secondary ms-2 shadow-sm" style="display:none;">Back</button>
    </div>
    
    <div class="col-md-6 text-md-end">
      <button type="button" class="btn btn-success me-2 shadow-sm" id="markAllPresent">All Present</button>
      <button type="button" class="btn btn-danger shadow-sm" id="markAllAbsent">All Absent</button>
    </div>
  </div>

  <!-- Inline Red Message -->
  <div id="searchMsg" class="text-danger fw-bold text-center mb-2" style="display:none;"></div>

  <!-- Students Table -->
  <div class="table-responsive shadow rounded p-2 bg-white">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-dark text-center">
        <tr>
          <th>Roll No</th>
          <th>Name</th>
          <th>Father Name</th>
          <th>Attendance</th>
        </tr>
      </thead>
      <tbody id="studentTableBody">
        <% for(let data of students){ %>
          <tr class="text-center">
            <td><%= data.rollNo %></td>
            <td><%= data.name %></td>
            <td><%= data.fatherName %></td>
            <td>
              <div class="d-flex justify-content-center align-items-center">
                <button class="btn btn-sm btn-success mark-btn" data-id="<%= data._id %>" data-status="Present">P</button>
                <button class="btn btn-sm btn-danger ms-2 mark-btn" data-id="<%= data._id %>" data-status="Absent">A</button>
                <span class="ms-3 fw-bold status"><%= data.attendanceToday || "" %></span>
              </div>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <div class="text-center mt-3">
    <a class="btn btn-primary col-4 fw-bold" id="doneBtn" href="/student/attendance/record">Done</a>
  </div>
</div>

<script>

  const description = document.getElementById("description");
  const charCount = document.getElementById("charCount");

  description.addEventListener("input", () => {
    const length = description.value.length;
    charCount.textContent = `${length} / 200`;

    if (length >= 200) {
      charCount.classList.remove("text-secondary");
      charCount.classList.add("text-danger");
    } else {
      charCount.classList.remove("text-danger");
      charCount.classList.add("text-secondary");
    }
  });

document.addEventListener("DOMContentLoaded", () => {
  const doneBtn = document.getElementById("doneBtn");
  const msgBox = document.getElementById("searchMsg");
  const backBtn = document.getElementById("backBtn");
  const tableBody = document.getElementById("studentTableBody");
  const studentsData = {};
  const originalTableBody = tableBody.innerHTML;

  function markStudent(studentId, status, td) {
    const statusSpan = td.querySelector(".status");
    statusSpan.textContent = status;
    statusSpan.classList.remove("text-success", "text-danger");
    statusSpan.classList.add(status === "Present" ? "text-success" : "text-danger");
    studentsData[studentId] = status;
  }

  function attachEvents() {
    document.querySelectorAll(".mark-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        markStudent(btn.getAttribute("data-id"), btn.getAttribute("data-status"), btn.closest("td"));
      });
    });
  }

  attachEvents();

  // Bulk buttons
  document.getElementById("markAllPresent").addEventListener("click", () => {
    document.querySelectorAll(".mark-btn[data-status='Present']").forEach(btn => {
      markStudent(btn.getAttribute("data-id"), "Present", btn.closest("td"));
    });
  });

  document.getElementById("markAllAbsent").addEventListener("click", () => {
    document.querySelectorAll(".mark-btn[data-status='Absent']").forEach(btn => {
      markStudent(btn.getAttribute("data-id"), "Absent", btn.closest("td"));
    });
  });

  // Search
  document.getElementById("searchBtn").addEventListener("click", async () => {
    const searchVal = document.getElementById("searchInput").value.trim();
    if (!searchVal) return;

    const res = await fetch(`/search/attendance/student?name=${encodeURIComponent(searchVal)}`);
    const response = await res.json();

    tableBody.innerHTML = "";
    msgBox.style.display = "none";

    if (!response.success) {
      msgBox.innerText = response.message;
      msgBox.style.display = "block";
      backBtn.style.display = "inline-block";
      return;
    }

    response.data.forEach(s => {
      tableBody.innerHTML += `
        <tr class="text-center">
          <td>${s.rollNo}</td>
          <td>${s.name}</td>
          <td>${s.fatherName}</td>
          <td>
            <div class="d-flex justify-content-center align-items-center">
              <button class="btn btn-sm btn-success mark-btn" data-id="${s._id}" data-status="Present">P</button>
              <button class="btn btn-sm btn-danger ms-2 mark-btn" data-id="${s._id}" data-status="Absent">A</button>
              <span class="ms-3 fw-bold status">${s.attendanceToday || ""}</span>
            </div>
          </td>
        </tr>`;
    });

    attachEvents();
    backBtn.style.display = "inline-block";
  });

  // Back button
  backBtn.onclick = () => {
    tableBody.innerHTML = originalTableBody;
    attachEvents();
    msgBox.style.display = "none";
    backBtn.style.display = "none";
    document.getElementById("searchInput").value = "";
  };

  // Done button
  doneBtn.addEventListener("click", async (e) => {
    const period = parseInt(document.getElementById("period").value, 10);
    const unit = document.getElementById("unit").value.trim();
    const description = document.getElementById("description").value.trim();
    const subject = document.getElementById("subject").value.trim();

    if (!period || period < 1 || period > 6) { e.preventDefault(); alert("Enter valid period 1-6"); return; }
    if (!unit) { e.preventDefault(); alert("Unit is required!"); return; }
    if (!description || description.length > 200) { e.preventDefault(); alert("Description max 200 chars!"); return; }
    if (!subject) { e.preventDefault(); alert("Select a subject!"); return; }

    const allMarked = Array.from(document.querySelectorAll(".status")).every(s => s.textContent.trim());
    if (!allMarked) { e.preventDefault(); alert("Mark all students first!"); return; }

    try {
      await fetch("/attendance/saveAll", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ students: studentsData, period, unit, description, subject })
      });
      window.location.href = "/student/attendance/record";
    } catch (err) { console.error(err); }
  });
});
</script>
