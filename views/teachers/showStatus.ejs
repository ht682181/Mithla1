<% layout("layouts/boilerplateTeacher") %>

<div class="container mt-4">

  <!-- Header -->
  <% if (dupDatas.length > 0 && dupDatas[0].attendance.length > 0) { %>
    <div class="text-center mb-4">
      <h4 class="fw-bold text-primary">
        ðŸ“… Attendance Date:
        <%= dupDatas[0].attendance[dupDatas[0].attendance.length - 1].date.toDateString() %>
      </h4>
      <p class="text-muted">Attendance for 6 periods</p>
    </div>
  <% } %>

  <!-- Class Info -->
  <div class="container my-4 text-center">
    <% if (!dupDatas.length || !dupDatas[0]?.studentId) { %>
      <div class="alert alert-warning">
        Data not available.
      </div>
    <% } else { %>
      <% const student = dupDatas[0].studentId; %>
      <div class="d-flex justify-content-center gap-3 flex-wrap">
        <div>
          Class:
          <span class="badge bg-primary fs-6"><%= student.class %></span>
        </div>
        <div>
          Semester:
          <span class="badge bg-success fs-6"><%= student.semester %></span>
        </div>
        <div>
          Section:
          <span class="badge bg-warning text-dark fs-6"><%= student.section %></span>
        </div>
      </div>
    <% } %>
  </div>

  <!-- Attendance Table -->
  <div class="card shadow-lg rounded-4 border-0">
    <div class="card-body p-3">
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle mb-0 text-center">
          <thead class="table-dark">
            <tr>
              <th class="text-start">Name</th>
              <th class="text-start">Father Name</th>
              <th>I</th>
              <th>II</th>
              <th>III</th>
              <th>IV</th>
              <th>V</th>
              <th>VI</th>
            </tr>
          </thead>

          <tbody>

            <!-- ðŸ”¥ Period Wise Counter Logic -->
            <%
              let periodCounts = [0,0,0,0,0,0];
              const totalStudents = datas.length;

              datas.forEach(data => {
                let dup = dupDatas.find(
                  d => d.studentId && d.studentId._id.toString() === data._id.toString()
                );

                if (dup && dup.attendance) {
                  for (let i = 0; i < 6; i++) {
                    if (dup.attendance[i] && dup.attendance[i].status === "Present") {
                      periodCounts[i]++;
                    }
                  }
                }
              });

              const teacherRef = dupDatas.find(d => d.attendance && d.attendance.length);
            %>

            <!-- ===== STUDENT ROWS ===== -->
            <% for (let data of datas) { %>

              <% 
                let dup = dupDatas.find(
                  d => d.studentId && d.studentId._id.toString() === data._id.toString()
                ); 
              %>

              <tr>
                <td class="fw-bold text-start">
                  <i class="fa-solid fa-user me-2 text-primary"></i>
                  <%= data.name %>
                </td>
                <td class="text-start"><%= data.fatherName %></td>

                <% for (let i = 0; i < 6; i++) { %>
                  <% if (dup && dup.attendance[i]) { %>
                    <td>
                      <span class="badge <%= dup.attendance[i].status === 'Present' ? 'bg-success' : 'bg-danger' %>">
                        <%= dup.attendance[i].status %>
                      </span>
                    </td>
                  <% } else { %>
                    <td class="text-muted">-</td>
                  <% } %>
                <% } %>
              </tr>

            <% } %>

            <!-- ===== TEACHER ROW ===== -->
            <% if (teacherRef) { %>
              <tr class="bg-light border-top">
                <td colspan="2" class="fw-semibold text-end text-muted">
                  Teacher â†’
                </td>

                <% for (let i = 0; i < 6; i++) { %>
                  <td class="small fw-semibold text-primary">
                    <%= teacherRef.attendance[i]?.teacherName || "-" %>
                  </td>
                <% } %>
              </tr>
            <% } %>

            <!-- ===== TOTAL PRESENT ROW ===== -->
            <tr class="table-info fw-bold border-top">
              <td colspan="2" class="text-end text-primary">
                Total Present â†’
              </td>

              <% for (let i = 0; i < 6; i++) { %>
                <td>
                  <span class="badge bg-primary">
                    <%= periodCounts[i] %> / <%= totalStudents %>
                  </span>
                </td>
              <% } %>
            </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- Script for coloring badges (optional fallback) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const statusCells = document.querySelectorAll(".status");

    statusCells.forEach(cell => {
      const text = cell.textContent.trim();
      if(text === "Present"){
        cell.style.color = "#fff";
      } else if(text === "Absent"){
        cell.style.color = "#fff";
      } else {
        cell.style.color = "#6c757d";
      }
    });
  });
</script>
