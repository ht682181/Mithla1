<%- layout("/layouts/boilerplate") -%>

<div class="container my-5">

  <!-- ===== PAGE HEADER ===== -->
  <div class="text-center mb-4">
    <h1 class="fw-bold text-primary">ğŸ‘©â€ğŸ« Assigning Student Management</h1>
    <p class="text-muted">Bulk assign subjects to students easily</p>
  </div>

  <!-- ===== TOP ACTION BUTTONS ===== -->
  <div class="d-flex gap-3 mb-4 justify-content-start ms-3">
    <a href="/add/studentData"
       class="btn btn-dark shadow-sm px-4 py-2 rounded-pill fw-semibold">
      <i class="fa-solid fa-plus me-2"></i>Add Student
    </a>

    <a href="/show/student"
       class="btn btn-dark shadow-sm px-4 py-2 rounded-pill fw-semibold">
      <i class="fa-solid fa-eye me-2"></i>Show Student Data
    </a>
  </div>

  <!-- ===== MAIN CARD ===== -->
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <div class="card shadow-lg rounded-4">
        <div class="card-body p-4">

          <h4 class="fw-bold text-center mb-4">ğŸ“˜ Assign Subjects to Students</h4>

          <form action="/assign/student/subject" method="post" novalidate class="needs-validation">

            <!-- ===== CLASS & SEMESTER ===== -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Class</label>
                <select name="data[class]" id="class" class="form-select  shadow-sm" required>
                  <option value="">Choose class & year</option>
                  <% for(let data of classData){ %>
                    <option value="<%= data.class %>"><%= data.class %></option>
                  <% } %>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Semester</label>
                <input name="data[semester]" id="semester" class="form-control  shadow-sm"
                       placeholder="Enter semester" list="option" required>
                <datalist id="option">
                  <% for(let i=1;i<=8;i++){ %>
                    <option value="<%= i %>"></option>
                  <% } %>
                </datalist>
              </div>
            </div>

            <!-- ===== SUBJECTS ===== -->
            <div class="mt-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="fw-semibold">ğŸ“š Subjects</label>
                <div class="form-check">
                  <input type="checkbox" id="selectAllSubjects" class="form-check-input">
                  <label class="form-check-label">Select All</label>
                </div>
              </div>

              <div id="subject-container"
                   class="border rounded-3 p-3 bg-light"
                   style="max-height:220px; overflow-y:auto;">
                <p class="text-muted text-center mb-0">Select class & semester to load subjects</p>
              </div>
            </div>

            <!-- ===== STUDENTS ===== -->
            <div class="mt-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="fw-semibold">ğŸ‘¨â€ğŸ“ Students</label>
                <div class="form-check">
                  <input type="checkbox" id="selectAllStudents" class="form-check-input">
                  <label class="form-check-label">Select All</label>
                </div>
              </div>

              <div class="d-flex fw-bold border-bottom pb-1 mb-2">
                <div class="col-6">Name</div>
                <div class="col-6">Father Name</div>
              </div>

              <div id="student-container"
                   class="border rounded-3 p-2 bg-light"
                   style="max-height:220px; overflow-y:auto;">
                <p class="text-muted text-center mb-0">Select class & semester to load students</p>
              </div>
            </div>

            <!-- ===== SUBMIT ===== -->
            <div class="text-center mt-4">
              <button class="btn btn-primary px-5 py-2 rounded-pill shadow">
                âœ… Assign Subjects
              </button>
            </div>

          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function loadData() {
  let className = document.getElementById("class").value;
  let semester = document.getElementById("semester").value;
  if (!className || !semester) return;

  try {
    // ===== SUBJECTS =====
    let resSub = await fetch(`/get-subjects/${className}/${semester}`);
    let subjects = await resSub.json();
    let subContainer = document.getElementById("subject-container");
    subContainer.innerHTML = "";

    subjects.forEach((sub, i) => {
      let subjectData = encodeURIComponent(JSON.stringify({
        name: sub.name,
        code: sub.code,
        maxMarks: sub.maxMarks,
        minMarks: sub.minMarks,
        subjectType: sub.subjectType
      }));

      subContainer.innerHTML += `
        <div class="form-check border-bottom py-1">
          <input class="form-check-input subject-checkbox"
                 type="checkbox"
                 name="data[subjects][]"
                 value="${subjectData}"
                 id="subject${i}">
          <label class="form-check-label" for="subject${i}">
            <strong>${sub.name}</strong>
            <small class="text-muted">
              (Code:${sub.code}, Max:${sub.maxMarks}, Min:${sub.minMarks}, ${sub.subjectType})
            </small>
          </label>
        </div>
      `;
    });

    // ===== STUDENTS =====
    let resStu = await fetch(`/get-students/${className}/${semester}`);
    let students = await resStu.json();
    let stuContainer = document.getElementById("student-container");
    stuContainer.innerHTML = "";

    students.forEach((stu, i) => {
      stuContainer.innerHTML += `
        <div class="form-check d-flex align-items-center border-bottom py-1">
          <input class="form-check-input student-checkbox me-2"
                 type="checkbox"
                 name="data[students][]"
                 value="${stu._id}"
                 id="student${i}">
          <label class="form-check-label w-100 d-flex">
            <span class="col-6">${stu.name}</span>
            <span class="col-6">${stu.fatherName}</span>
          </label>
        </div>
      `;
    });

  } catch (err) {
    console.error("Error loading data", err);
  }
}

document.getElementById("class").addEventListener("change", loadData);
document.getElementById("semester").addEventListener("change", loadData);

document.getElementById("selectAllSubjects").addEventListener("change", e => {
  document.querySelectorAll(".subject-checkbox").forEach(cb => cb.checked = e.target.checked);
});

document.getElementById("selectAllStudents").addEventListener("change", e => {
  document.querySelectorAll(".student-checkbox").forEach(cb => cb.checked = e.target.checked);
  
});

document.querySelector("form").addEventListener("submit", function(e) {     
  if(document.querySelectorAll(".subject-checkbox:checked").length === 0 || 
     document.querySelectorAll(".student-checkbox:checked").length === 0) {       
    e.preventDefault();       
    alert("Please select at least one subject and one student!");     
  }   
});


</script>
